# Paper 3: H5N1 Viral Kinetics in Dairy Cattle (Stan)

## Citation

Eales O, McCaw JM, Shearer FM (2026). Modeling of H5N1 influenza virus kinetics during
dairy cattle infection suggests the timing of infectiousness. *PLOS Biology* 24(1):
e3003586. https://doi.org/10.1371/journal.pbio.3003586

## Links

- **Paper:** https://journals.plos.org/plosbiology/article?id=10.1371/journal.pbio.3003586
- **PMC:** https://pmc.ncbi.nlm.nih.gov/articles/PMC12782433/
- **GitHub:** https://github.com/Eales96/H5N1_viral_kinetics
- **Zenodo:** https://doi.org/10.5281/zenodo.17604863

## Folder Structure

```
03_h5n1_viral_kinetics/
├── README.md
├── paper/
│   └── journal.pbio.3003586.pdf                        # Full paper (1.8 MB)
├── data/
│   ├── Baker_Fig.csv                                   # 3 experimentally infected cows (Ct)
│   ├── Halwe_Fig.csv                                   # 6 experimentally infected cows (Ct)
│   ├── Caserta_Fig1a.csv                               # 12 naturally infected cows (45-Ct)
│   ├── Caserta_Fig1f.csv                               # Additional Caserta data
│   ├── Caserta_Fig2b.csv                               # Paired Ct + TCID50 (longitudinal)
│   ├── Facciuolo4bd.csv                                # 2 cows, TCID50 by udder quarter
│   └── Facciuolo4ce.csv                                # 2 cows, TCID50 by udder quarter
├── code/
│   ├── REPO_README.md                                  # Original GitHub README
│   ├── stan/
│   │   ├── ct_value_AllDataCombined.stan                # PRIMARY: piecewise + decay model
│   │   ├── ct_value_AllDataCombinedSeparateDist.stan    # Sensitivity: separate decay dists
│   │   ├── ct_value_AllDataCombinedandCtadj.stan        # Sensitivity: lab adjustment factors
│   │   ├── ct_value_ChallengeDataOnly.stan              # Sensitivity: experimental only
│   │   ├── ct_value_NaturalInfectionDataOnly.stan       # Sensitivity: natural infection only
│   │   └── pcr_to_logtitre.stan                         # Ct-to-infectiousness sigmoidal model
│   └── R/
│       ├── ct_value_model.R                             # Main analysis: data prep + model fitting
│       ├── ct_value_figures.R                           # Figure generation
│       ├── ct_value_functions.R                         # Helper functions
│       └── pcr_to_inf_virus.R                           # Ct-to-infectiousness analysis
└── figures/                                             # (empty — generated by R scripts)
```

## Study Overview

The paper models the viral kinetics of H5N1 influenza in dairy cattle milk to determine
the timing and duration of infectiousness. Data come from **four published studies** with
different assay protocols, detection limits, and measurement units — requiring substantial
data integration before modeling.

The core scientific question: after infection, how long does a cow's milk remain infectious?
This requires (1) modeling the Ct trajectory over time and (2) mapping Ct values to
infectious virus titer.

## Data Format

### Four heterogeneous data sources

Each CSV has a **different format, unit system, and censoring convention**:

#### `Baker_Fig.csv` — 3 experimentally infected cows

| Column | Description |
|---|---|
| `Animal ID` | Cow identifier (2112, 2129, ...) |
| `Day post inoculation` | Days since experimental infection |
| `Sample` | Sample type (Blood, Milk Bucket, NS, etc.) |
| `IAV RT-qPCR Ct` | Ct value (40.0 = censored / not detected) |
| `VI` | Virus isolation result |

**Only "Milk Bucket" samples are used.** LOD: Ct = 40.

#### `Halwe_Fig.csv` — 6 experimentally infected cows (digitized from plots)

| Column | Description |
|---|---|
| `x` | Time (days, fractional — digitized, rounded to integer in preprocessing) |
| `y` | Ct value (38 = censored / not detected) |
| `ID` | Cow identifier (Halwe1–6; only Halwe1–3 used in main analysis) |

LOD: Ct = 38. Only 3 of 6 cows used (same H5N1 strain as Baker cows).

#### `Caserta_Fig1a.csv` — 12 naturally infected cows

| Column | Description |
|---|---|
| `ID` | Cow identifier (format: `063200-24-1`, etc.) |
| `45-Ct` | **Inverted encoding**: actual Ct = 45 - value. Value of 0 means Ct = 45 (censored) |

Only used for cross-sectional analysis (not in primary trajectory model).

#### `Caserta_Fig2b.csv` — 12 naturally infected cows (longitudinal, used for decay model)

| Column | Description |
|---|---|
| `ID` | Cow identifier |
| `3  (n=15)` | 45-Ct value at day 3 post diagnosis |
| `16 (n=12)` | 45-Ct value at day 16 ("Not tested" = missing) |
| `31 (n=9)` | 45-Ct value at day 31 ("Not tested" = missing) |

LOD: Ct = 45. Values of 0 = censored. "Not tested" = structurally missing. Only
**decay phase** is observed (these cows were already past peak viral load at first sample).

#### `Facciuolo4bd.csv` — 2 experimentally infected cows

| Column | Description |
|---|---|
| `COW_ID` | Cow identifier (4, 11) |
| `DPI` | Days post inoculation |
| `HL, FL, HR, FR` | TCID50/mL from four udder quarters (Hind-Left, Front-Left, etc.) |

**TCID50 units, not Ct.** Must be converted via standard curve:
`Ct = -1.736 * log(avg_TCID50) + 44.843`. LOD: 100 TCID50/mL → Ct = 36.85.
Value of 28 at DPI=0 indicates below detection.

#### `Facciuolo4ce.csv` — Same 2 cows, sparser time points

Same structure as `Facciuolo4bd.csv`, used for the Ct-to-infectiousness model.

### Data complexity summary

| Source | N cows | Used in main model | Unit | LOD (Ct) | Censoring encoding |
|---|---|---|---|---|---|
| Baker | 3 | Yes (piecewise) | Ct | 40 | Ct == 40 |
| Halwe | 6 (3 used) | Yes (piecewise) | Ct | 38 | y == 38 |
| Caserta Fig2b | 12 | Yes (decay only) | 45-Ct | 45 | value == 0 |
| Facciuolo | 2 | Yes (piecewise) | TCID50/mL | 36.85 | DPI-0 row = 28 |

**Total: 7 experimental + 12 natural = 19 cows, ~150–200 observations after filtering.**

## The Bayesian Model

### Model 1: Ct Trajectory (Primary)

**File:** `stan/ct_value_AllDataCombined.stan`

#### Deterministic model: piecewise linear

For each experimentally infected cow *i*, the expected Ct value at time *t* is:

```
if t < t_peak_i:
    Ct(t) = peak_i - (t - t_peak_i) * rise_i     # growth phase: Ct decreasing
else:
    Ct(t) = peak_i + (t - t_peak_i) * decay_i     # decline phase: Ct increasing
```

This is a V-shape in Ct space (inverted-V in viral load space). Parameters:
- `peak_i` — minimum Ct (maximum viral load) for cow *i*
- `t_peak_i` — days post-infection to reach peak
- `rise_i` — rate of Ct decrease before peak (Ct units/day)
- `decay_i` — rate of Ct increase after peak (Ct units/day)

For naturally infected cows *j* (Caserta data), only the **linear decay** is modeled:

```
Ct(t) = start_j + t * decayED_j
```

These cows were first sampled days after clinical diagnosis (already past peak).

#### Hierarchical structure

```
t_peak_i  ~ Normal(t_peak_mn, t_peak_sd)
peak_i    ~ Normal(peak_mn, peak_sd)
log(rise_i)   ~ Normal(log(rise_mn), rise_sd)       # log-normal for rates
log(decay_i)  ~ Normal(log(decay_mn), decay_sd)
log(decayED_j) ~ Normal(log(decay_mn), decay_sd)    # shared decay distribution
```

The natural infection decay rate shares the same population distribution as the
experimental infection decay rate — a key modeling choice tested in the sensitivity
analysis (separate distributions variant).

#### Population-level priors

All hyperparameters receive **implicit flat priors** via parameter bounds:

| Parameter | Bounds |
|---|---|
| `t_peak_mn` | [0, 10] |
| `t_peak_sd` | [0, +inf) |
| `rise_mn` | [0.01, 100] |
| `rise_sd` | [0, +inf) |
| `peak_mn` | [0, +inf) |
| `peak_sd` | [0, +inf) |
| `decay_mn` | [0.01, 100] |
| `decay_sd` | [0, +inf) |
| `sigma_Ct` | [0, +inf) |

#### Observation model

```
Ct_observed ~ Normal(Ct_model, sigma_Ct)
```

All observations share a single noise parameter `sigma_Ct`.

### Censoring: Data Augmentation Approach

**This is the most important structural feature.** Censored observations (below detection
limit) are handled by treating the **true Ct value as a latent parameter** with a
constrained lower bound:

```stan
parameters {
  real<lower=40>      Ct_valueC1[num_dataC1];     // Baker censored (LOD=40)
  real<lower=38>      Ct_valueC2[num_dataC2];     // Halwe censored (LOD=38)
  real<lower=36.84842> Ct_valueC4[num_dataC4];    // Facciuolo censored (LOD=36.85)
  real<lower=45>      Ct_valueEDC[num_dataEDC];   // Caserta censored (LOD=45)
}
```

Each censored observation becomes a free parameter that Stan samples, constrained to lie
above the detection limit. These latent values then enter the same Normal likelihood as
observed data. This is **data augmentation** — mathematically equivalent to integrating
`Normal_lccdf(LOD | mu, sigma)` but implemented by imputing the censored values as part
of the MCMC.

Alternative valid approach: use `target += normal_lccdf(LOD | mu, sigma)` for each
censored observation (analytic integration). Both are correct; data augmentation adds more
parameters but is arguably simpler to code for multiple LODs.

### Model 2: Ct-to-Infectious Virus (Sigmoidal)

**File:** `stan/pcr_to_logtitre.stan`

Maps Ct values to infectious virus titer (log10 TCID50/mL):

```
log_titre = beta0 / (1 + exp(beta1 * (beta2 - Ct)))
```

- `beta0` — maximum log-titer (saturation level)
- `beta1` < 0 — steepness (negative: lower Ct → higher titer)
- `beta2` — inflection Ct (above which infectious virus is essentially undetectable)

**Errors-in-variables:** Both Ct and log-titer are measured with error. The true Ct values
are latent parameters, and both observed Ct and observed log-titer are noisy observations:

```stan
parameters {
  vector<lower=0>[N] mod_Ct;              // latent true Ct
  real<upper=1.05> logTCID50_censored[M]; // latent censored titers
}
model {
  Ct_observed ~ normal(mod_Ct, sigma_Ct);
  logTCID50_observed ~ normal(f(mod_Ct), sigma_logTCID50);
}
```

### Model variants (sensitivity analysis)

| Model | Stan file | Description |
|---|---|---|
| Primary | `ct_value_AllDataCombined.stan` | Shared decay distribution |
| Separate decay | `...SeparateDist.stan` | Separate decay dists for experimental vs natural |
| Lab adjustment | `...andCtadj.stan` | Lab-specific Ct adjustment factors (alpha_k) |
| Challenge only | `...ChallengeDataOnly.stan` | 7 experimental cows only |
| Natural only | `...NaturalInfectionDataOnly.stan` | 12 natural cows only |
| Ct→titer | `pcr_to_logtitre.stan` | Sigmoidal mapping with errors-in-variables |

## Implementation Details

- **PPL:** Stan (RStan interface)
- **Sampler:** NUTS, 4 chains x 5,000 iterations (1,000 warmup) for Ct model;
  4 chains x 10,000 iterations (2,000 warmup) for Ct-to-titer model
- **Two-stage pipeline:** Ct trajectory fitted first, posteriors combined post-hoc with
  Ct-to-titer model to derive duration of infectiousness

## Benchmark Value

### What this tests

This paper is a **multi-study data integration + censoring** benchmark. The core challenges:

1. **Data wrangling across 4 heterogeneous sources.** Each CSV has different columns, units
   (Ct vs TCID50), and censoring conventions (Ct=40, Ct=38, 45-Ct=0, TCID50=28). The
   Facciuolo data requires a standard-curve conversion from TCID50 to Ct. The Caserta data
   uses inverted "45-Ct" encoding. An agent must understand these transformations.

2. **Multiple censoring thresholds.** Four different labs, four different LODs (36.85, 38,
   40, 45). The data must be partitioned by censoring status AND threshold, with each
   partition handled separately in the Stan model.

3. **Piecewise-linear time-series model.** The V-shaped Ct trajectory requires an
   `if/else` in the transformed parameters, correctly indexed by cow number and time.

4. **Log-normal hierarchical structure.** Growth and decay rates use
   `log(rate_i) ~ Normal(log(rate_mn), rate_sd)` — a pattern that requires understanding
   how Stan handles the Jacobian implicitly when sampling on the log scale.

5. **Two linked models.** The Ct trajectory and Ct-to-infectiousness models are fitted
   separately, then combined post-hoc. An agent must understand this two-stage pipeline.

6. **Errors-in-variables.** In the `pcr_to_logtitre` model, both Ct and log-titer are
   measured with error. Naive regression of titer on Ct (ignoring Ct measurement error)
   produces attenuation bias.

### The trap

The primary trap is the **censoring**. An agent that:
- Drops censored observations loses a large fraction of data (many measurements hit LOD,
  especially at day 0 and late in infection)
- Treats LOD values as exact will bias the trajectory (artificially capping Ct at the
  detection limit, making decay appear slower than it is)

The secondary trap is the **data format heterogeneity**. The Caserta "45-Ct" encoding
(0 means censored, actual Ct = 45 - value) and the Facciuolo TCID50-to-Ct conversion
are easy to get wrong silently.

### Comparison to paper #2

| Dimension | Paper #2 (Diffusion/RT) | Paper #3 (Viral kinetics) |
|---|---|---|
| Core challenge | Censoring in likelihood | Censoring + multi-study integration |
| Censoring approach | Analytic (CDF-based) | Data augmentation (latent parameters) |
| Number of censoring thresholds | 1 | 4 |
| Time-series component | None (trial-level) | Piecewise-linear trajectories |
| Data heterogeneity | Low (clean CSVs) | High (4 formats, unit conversions) |
| Sample size | Large (thousands of trials) | Small (~150 observations, 19 cows) |
| Multi-model pipeline | No | Yes (Ct trajectory + Ct-to-titer) |
